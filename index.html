<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" /> -->
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <title>Meeting Room Booking</title>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/css/styles.min.css" />
    <link rel="stylesheet" href="assets/font-awesome/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css?family=Poppins&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/alertifyjs/css/alertify.min.css" />
    <script src="assets/jquery.min.js"></script>
    <script src="assets/bootstrap.bundle.min.js"></script>
    <script src="assets/alertifyjs/alertify.min.js"></script>
    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        
        .show_btnTime::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE and Edge */
        
        .show_btnTime {
            -ms-overflow-style: none;
        }
        
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        #full-size {
            padding-left: 15px;
            padding-top: 20px;
            padding-right: 28px;
        }
        
        .bodyDanger {
            background: #FF416C;
            background: -webkit-linear-gradient(to right, #FF4B2B, #FF416C);
            background: linear-gradient(to right, #FF4B2B, #FF416C);
        }

        .bodyFine {
            background: #232526;
            background: -webkit-linear-gradient(to bottom, #414345, #232526);
            background: linear-gradient(to bottom, #414345, #232526);
        }

        .bodyGo {
            background: #FDC830;
            background: -webkit-linear-gradient(to bottom, #F37335, #FDC830);
            background: linear-gradient(to bottom, #F37335, #FDC830);
        }
    </style>
</head>

<body class="bodyFine">
    <div id="full-size">
        <div class="row">
            <div class="col-md-6 offset-md-0" style="height: 150px;" id="room_name">
                <h1 id="titleRoom" style="padding-top: 35px;padding-left: 18px;color: white;"></h1>
                <h6 id="fetchData" style="padding-left: 18px;color: white;"> Please wait, Fetching data...</h6>
            </div>
            <div class="col-md-6" id="time" align="right">
                <h1 onclick="refresh()" style="padding-top: 35px; padding-right:18px; color: white;" id="showing_time"></h1>
                <h4 style="color: white; padding-right:18px;" id="showing_date"></h4>
            </div>
        </div>
        <br>
        <div class="row">
            <div class="col-md-3 offset-md-0" style="height: 100px;" id="room_name">
                <!-- <small style="font-size: 20px;color: white;">Room Status</small> -->
                <h6 id="statusRoom" style="color: white;"> Next meeting, 14:30 - 15:00 <br> Host: Developer </h6>
                <button id="btnPlay" class="btn btn-dark"> Start </button>
            </div>
            <div class="col-md-3 offset-md-0 text-center">
                <div id="time_value">
                    <h2 id="label_start" style="color: white; font-size: 22px"></h2>
                    <h1 id="start_from" style="color: white; font-size: 40px"></h1>
                </div>
            </div>
            <div class="col-md-3 offset-md-0 text-center">
                <div id="time_value">
                    <h2 id="label_end" style="color: white; font-size: 22px"></h2>
                    <h1 id="end_from" style="color: white; font-size: 40px"></h1>
                </div>
            </div>
            <div class="col-md-3 offset-md-0 text-center" id="btn_action" hidden>
                <button type="button" class="btn btn-dark" id="submit_sch" data-toggle="tooltip" data-placement="right" title="Save" onclick="saveData();"><i class="fa fa-save"></i></button>
                <button type="button" class="btn btn-dark" id="reset_sch" data-toggle="tooltip" data-placement="right" title="Reset" onclick="reset();"><i class="fa fa-refresh"></i></button>
            </div>
        </div>
        <br>
        <div class="row">
            <div class="col-md-12 show_btnTime btn-group" style="overflow-x: scroll; white-space: nowrap; pointer-events: none;" id="show_btnTime"></div>
        </div>

    </div>

    <!--Modal Login Form-->
    <div class="modal fade" id="modalLoginForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content" style="background-color: rgb(185, 194, 202);">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">Sign in</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="POST" id="formlogin">
                    <div class="modal-body mx-3">
                        <div class="md-form mb-5">
                            <label for="employee_id">Employee ID</label>
                            <input type="text" id="employee_id" autocomplete="off" name="employee_id" class="form-control" required>
                        </div>

                        <div class="md-form mb-5">
                            <label for="defaultForm-pass">Password</label>
                            <input type="password" name="password" id="defaultForm-pass" class="form-control" required>
                        </div>

                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button type="button" data-dismiss="modal" class="btn btn-warning">Cancel</button>
                        <button type="submit" class="btn btn-primary">Login and Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!--Modal Login Form-->
    <div class="modal fade" id="modalSetting" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content" style="background-color: rgb(185, 194, 202);">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">Setting</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="POST" id="formSetting">
                    <input type="hidden" name="random" value="" id="codeRandom">
                    <div class="modal-body mx-3">
                        <div class="md-form mb-5">
                            <label for="code">Tablet Code</label>
                            <input type="text" id="code" autocomplete="off" name="code" class="form-control" required>
                        </div>
                        <div class="md-form mb-5">
                            <label for="baseUrl">Base Url</label>
                            <input type="text" placeholder="http://192.168.1.1/meeting" id="baseUrl" autocomplete="off" name="baseUrl" class="form-control" required>
                        </div>

                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button type="submit" class="btn btn-success">Set</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</body>
<script type="text/javascript">
    var startTime = "";
    var endTime = "";
    var wantRefresh = 0;
    var MS_PER_MINUTE = 60000;
    alertify.set('notifier', 'position', 'top-right');

    document.querySelector('#baseUrl').value = localStorage.getItem('baseUrl');
    document.querySelector('#code').value = localStorage.getItem('codeTablet');
    document.getElementById('titleRoom').textContent = localStorage.getItem('nameTablet');

    if (localStorage.getItem("baseUrl") == null) {
        localStorage.setItem("baseUrl", "http://localhost/meetingrb");
    }

    function getData() {

        if (localStorage.getItem('roomCode') == null) {
            return false;
        }

        document.querySelector("#show_btnTime").style.pointerEvents = "none";

        let formData = new URLSearchParams();
        formData.append('roomCode', localStorage.getItem('roomCode'));

        const options = {
            method: 'POST',
            body: formData,
        }
        var baseUrl = localStorage.getItem("baseUrl");

        fetch(baseUrl + '/api/reservation/datareservation', options)
            .then(res => res.json())
            .then((res) => {
                if (res.error) {
                    alertify.error(res.message);
                } else {

                    res.data.forEach(function(item, i) {

                        let from = document.querySelector("button[value='" + item.booking_from + "']");
                        let to = document.querySelector("button[value='" + item.booking_to + "']");
                        let length = parseInt(to.id) - parseInt(from.id);
                        // console.log(length);

                        if (length !== 1) {
                            for (let i = 0; i < length; i++) {

                                let id = parseInt(from.id) + parseInt(i);

                                let btn = document.querySelector("button[id='" + id + "']");

                                if (i != 0 && i !== length - 1)
                                    btn.textContent = '---';

                                if (i == length - 1)
                                    btn.textContent = item.booking_to;

                                btn.classList.add('btn-danger');
                                btn.classList.remove('btn-success');
                            }
                        } else {
                            for (let i = 0; i < length; i++) {

                                let id = parseInt(from.id) + parseInt(i);

                                let btn = document.querySelector("button[id='" + id + "']");
                                btn.textContent = item.booking_from + ' -- ' + item.booking_to;
                                btn.classList.add('btn-danger');
                                btn.classList.remove('btn-success', 'btn-info', 'btn-primary');
                            }
                        }

                    });
                    document.getElementById('fetchData').style.display = "none";
                    document.querySelector("#show_btnTime").style.pointerEvents = "";
                    // document.querySelector("#show_btnTime").classList.remove('pointer-events');
                    reset();
                }
            });

    }

    function refresh() {
        wantRefresh += 1;
        if (wantRefresh == 2) {
            document.getElementById('titleRoom').textContent = 'Refreshing...';
            location.reload();
        }
        return false;
    }

    function bootTime() {
        var today = new Date();
        var d = today.getDay();
        var dt = today.getDate();
        var mo = String(today.getMonth() + 1).padStart(2, "0");
        var y = today.getFullYear();
        var h = String(today.getHours()).padStart(2, "0");
        var m = String(today.getMinutes()).padStart(2, "0");
        var s = String(today.getSeconds()).padStart(2, "0");
        // m = checkTime(m);
        // s = checkTime(s);
        d = checkDay(d);
        document.getElementById("showing_time").innerHTML =
            h + ":" + m + ":" + s;
        document.getElementById("showing_date").innerHTML =
            d + ", " + dt + "/" + mo + "/" + y;
        $("#btn_" + h + "00").focus();
        var t = setTimeout(bootTime, 500);
        // console.log(h);
    }

    function checkDay(i) {
        if (i == 1) {
            i = "Monday";
        } else if (i == 2) {
            i = "Thursday";
        } else if (i == 3) {
            i = "Wednesday";
        } else if (i == 4) {
            i = "Tuesday";
        } else if (i == 5) {
            i = "Friday";
        } else if (i == 6) {
            i = "Saturday";
        } else {
            i = "Sunday";
        }
        return i;
    }

    function checkTime(i) {
        if (i < 10) {
            i = "0" + i;
        }
        return i;
    }

    function btnTime() {
        var today = new Date();
        var h = String(today.getHours()).padStart(2, "0");

        let sequence = 0;
        for (var i = 0; i < 24; i++) {
            var ix = checkTime(i);
            var html1 =
                '<button type="button" class="btn btn-success" type="button" style="margin-top: 100px; width: fit-content;height: 60px;font-size: 15px;" id="' + sequence + '" name="btn_' + ix + ':00" value="' + ix + ':00" onclick="setStart(\'' + ix + ':00\')">' + ix + ':00</button>';
            $("#show_btnTime").append(html1);
            sequence++;

            var html2 =
                '<button type="button" class="btn btn btn-success" type="button" style="margin-top: 100px; width: fit-content;height: 60px;font-size: 15px;" id="' + sequence + '" name="btn_' + ix + ':15" value="' + ix + ':15" onclick="setStart(\'' + ix + ':15\')">' + ix + ':15</button>';
            $("#show_btnTime").append(html2);
            sequence++;

            var html3 =
                '<button type="button" class="btn btn btn-success" type="button" style="margin-top: 100px; width: fit-content;height: 60px;font-size: 15px;" id="' + sequence + '" name="btn_' + ix + ':30" value="' + ix + ':30" onclick="setStart(\'' + ix + ':30\')">' + ix + ':30</button>';
            $("#show_btnTime").append(html3);
            sequence++;

            var html3 =
                '<button type="button" class="btn btn btn-success" type="button" style="margin-top: 100px; width: fit-content;height: 60px;font-size: 15px;" id="' + sequence + '" name="btn_' + ix + ':45" value="' + ix + ':45" onclick="setStart(\'' + ix + ':45\')">' + ix + ':45</button>';
            $("#show_btnTime").append(html3);
            sequence++;
        }

        document.querySelector('button[value=\'' + h + ':00\']').focus();
        document.querySelector('button[value=\'' + h + ':00\']').blur();
    }

    function setStart(value) {

        if (value == '23:30' && startTime == '') {
            return false;
        }

        var btnChoose = document.querySelector("button[value='" + value + "']");
        if (btnChoose.classList.contains('btn-danger')) {
            return false;
        }

        if (startTime !== "") {
            if (btnChoose.id < document.querySelector("button[value='" + startTime + "']").id) {
                return false;
            }
        }

        if (startTime == '') {

            let dt = new Date();

            if (Date.parse('01/01/2020 ' + dt.getHours() + ':' + dt.getMinutes() + ':' + dt.getSeconds()) > 
            Date.parse('01/01/2020 ' + value + ':00')) {
                alertify.error("Time has passed");
                return false;
            }

            // btnChoose.setAttribute("disabled", "");

            startTime = value;
            document.getElementById('label_start').textContent = 'Start :';
            document.getElementById('start_from').textContent = value;

            btnAfter(value);
            // btnBefore(value, btnChoose.id);

        } else {

            if (btnChecker(btnChoose)) {
                return false;
            }

            $('#show_btnTime :button').not("button[value='" + startTime + "']").not("button[class='btn btn-danger']").addClass('btn-success').removeClass('btn-info').removeAttr('disabled');
            btnAfter(value);
        }

        btnChoose.classList.add('btn-info');
        btnChoose.classList.remove('btn-success');
    }

    function btnChecker(btnChoose) {
        let from = document.querySelector("button[value='" + startTime + "']");
        // let to = document.querySelector("button[value='" + endTime + "']");
        let length = parseInt(btnChoose.id) - parseInt(from.id);

        for (let i = 0; i < length; i++) {

            let id = parseInt(from.id) + parseInt(i);
            let btn = document.querySelector("button[id='" + id + "']");
            if (btn.classList.contains('btn-danger')) {
                return true;
            }
        }
        return false;
    }

    function btnAfter(value) {

        var time = value;
        let tm = time.split(":");
        let hours = parseInt(tm[0]);
        let minutes = parseInt(tm[1]);
        let today = new Date();
        let month = today.getMonth();
        let day = today.getDate();
        let year = today.getFullYear();
        let choose = new Date(year, month, day, hours, minutes);
        let myStartDate = new Date(choose.getTime() + 15 * MS_PER_MINUTE);

        endTime = String(myStartDate.getHours()).padStart(2, "0") + ':' + String(myStartDate.getMinutes()).padStart(2, "0");
        document.getElementById('label_end').textContent = 'End :';
        document.getElementById('end_from').textContent = endTime;
        document.getElementById('btn_action').removeAttribute('hidden');
    }

    function saveData(token) {

        if (token === null || !token) {
            $('#modalLoginForm').modal({
                backdrop: 'static',
                keyboard: false
            });
            $('#formlogin').trigger('reset');
            return false;
        }

        let formData = new URLSearchParams();
        formData.append('start', startTime);
        formData.append('end', endTime);
        formData.append('platform', 'tablet');
        formData.append('roomCode', localStorage.getItem('roomCode'));

        const options = {
            method: 'POST',
            body: formData,
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                'X-API-KEY': token,
            }
        }
        var baseUrl = localStorage.getItem("baseUrl");

        fetch(baseUrl + '/api/reservation/store', options)
            .then(res => res.json())
            .then((res) => {
                if (res.error) {
                    alertify.error(res.message);
                } else {
                    alertify.success(res.message);
                    $('#modalLoginForm').modal('hide');
                    getData();
                }
            });
    }

    function reset() {

        $('#show_btnTime :button').addClass('btn-success').removeClass('btn-warning btn-info').removeAttr('disabled');

        endTime = "";
        startTime = "";

        document.getElementById('label_start').textContent = '';
        document.getElementById('label_end').textContent = '';
        document.getElementById('btn_action').setAttribute('hidden', true);

        document.querySelector('#start_from').textContent = "";
        document.querySelector('#end_from').textContent = "";
    }

    $(document).ready(function() {
        bootTime();
        btnTime();
        getData();

        $('#formlogin').submit(function(e) {
            e.preventDefault();

            const options = {
                method: 'POST',
                body: $(this).serialize(),
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                }
            }
            var baseUrl = localStorage.getItem("baseUrl");

            fetch(baseUrl + '/api/employees/check_login', options)
                .then(res => res.json())
                .then((res) => {
                    if (res.error) {
                        alertify.error(res.message);
                    } else {

                        if (res.admin) {
                            $('#modalLoginForm').modal('hide');
                            $('#modalSetting').modal({
                                backdrop: 'static',
                                keyboard: false
                            });
                            document.querySelector('#codeRandom').value = res.data.token;
                            return;
                        }

                        saveData(res.data.token);
                    }
                });
        });

        $('#formSetting').submit(function(e) {
            e.preventDefault();

            let formData = new URLSearchParams();
            formData.append('code', document.querySelector('#code').value);

            const options = {
                method: 'POST',
                body: formData,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                    'X-API-KEY': document.querySelector('#codeRandom').value,
                }
            }

            localStorage.setItem("baseUrl", document.querySelector('#baseUrl').value);
            var baseUrl = localStorage.getItem("baseUrl");

            fetch(baseUrl + '/api/tablets/setTablet', options)
                .then(res => res.json())
                .then((res) => {
                    if (res.error) {
                        alertify.error(res.message);
                    } else {

                        localStorage.setItem("nameTablet", res.area.name);
                        localStorage.setItem("roomCode", res.data.id_rooms);
                        localStorage.setItem("codeTablet", document.querySelector('#code').value);

                        document.getElementById('titleRoom').textContent = localStorage.getItem('nameTablet');
                        alertify.success(res.message);
                    }
                });
        });

    });
</script>

</html>